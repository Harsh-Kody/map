<div class="dashboard-container container-fluid py-4">
  <div class="row g-3 m-3">
    <!-- MAP CONTROLS -->
    <div class="col-lg-4 col-md-12">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">Map Controls</h5>
        </div>
        <div class="card-body d-flex flex-column justify-content-between text-center">
          <div *ngIf="!selectedImage; else imageActions" class="flex-grow-1 d-flex flex-column justify-content-center">
            <p class="text-muted mb-3">No Image Uploaded</p>
            <button class="btn btn-primary w-100" (click)="openModal('add')">
              <i class="bi bi-plus-circle"></i> Add Image
            </button>
          </div>

          <ng-template #imageActions>
            <div class="button-group mt-auto d-flex justify-content-center gap-2 flex-wrap">
              <!-- <div class="mb-3">
                <img
                  [src]="selectedImage"
                  alt="Map Preview"
                  class="img-fluid rounded border"
                />
              </div> -->
              <button class="btn btn-outline-warning btn-sm px-3" (click)="openModal('edit')">
                <i class="bi bi-pencil-square me-1"></i> Edit
              </button>
              <button class="btn btn-outline-info btn-sm px-3" (click)="openModal('view')">
                <i class="bi bi-eye me-1"></i> View
              </button>
              <button class="btn btn-outline-danger btn-sm px-3" (click)="deleteImage()">
                <i class="bi bi-trash me-1"></i> Delete
              </button>
              <button class="btn btn-outline-dark btn-navigation mt-auto" (click)="navigateLocalMap()">
                <i class="bi bi-compass me-2"></i>Go to Local Map
              </button>
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- ROBOT MAP -->
    <div class="col-lg-4 col-md-12">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Robot Map</h5>
        </div>
        <div class="card-body p-0">
          <div class="map-container">
            <app-robot></app-robot>
          </div>
        </div>
      </div>
    </div>

    <!-- VIBRATION GRAPH -->
    <div class="col-lg-4 col-md-12">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Vibration Intensity</h5>
        </div>
        <div class="card-body p-0">
          <div class="map-container">
            <app-robot-vibration></app-robot-vibration>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-12">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">Robot Speed</h5>
        </div>
        <div class="card-body p-0">
          <div class="map-container">
            <app-robot-speed />
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #imageModal let-modal>
    <div class="modal-header">
      <h5 class="modal-title text-capitalize">{{ modalMode }} Image</h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss(); clearSelection()"></button>
    </div>

    <div class="modal-body text-center">
      <!-- ADD / EDIT -->
      <div *ngIf="modalMode !== 'view'">
        <div *ngIf="!selectedFileName && !croppedImage">
          <i class="bi bi-image fs-1 text-secondary mb-3"></i>
          <p class="text-muted mb-2">Upload your image</p>
          <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" hidden />
          <button class="btn btn-primary" (click)="fileInput.click()">
            <i class="bi bi-upload"></i> Choose Image
          </button>
          <div *ngIf="errorMessage" class="alert alert-danger mt-3 small">
            {{ errorMessage }}
          </div>
        </div>

        <!-- Show Cropper when file selected -->
        <div *ngIf="selectedFileName" class="mt-3">
          <image-cropper [imageChangedEvent]="imageChangedEvent" format="png" [maintainAspectRatio]="false"
            (imageCropped)="imageCropped($event)" style="max-height: 300px"></image-cropper>
        </div>

        <!-- Preview + Save -->
        <div *ngIf="croppedImage" class="mt-3">
          <h6 class="text-muted mb-2">Preview</h6>
          <img [src]="croppedImage" class="img-fluid rounded shadow-sm mb-3" style="max-height: 200px" />
          <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-success btn-sm" (click)="onUpload(modal)">
              <i class="bi bi-check-circle"></i> Save
            </button>
            <button class="btn btn-outline-secondary btn-sm" (click)="clearSelection()">
              <i class="bi bi-arrow-repeat"></i> Change
            </button>
          </div>
        </div>
      </div>

      <!-- VIEW -->
      <div *ngIf="modalMode === 'view'">
        <img [src]="selectedImage" alt="View Image" class="img-fluid rounded shadow-sm" />
      </div>
    </div>
  </ng-template>
</div>