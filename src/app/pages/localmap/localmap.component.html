<div class="map-container">
  <!-- <canvas #mapCanvas id="map-canvas" (click)="onCanvasClick($event)"></canvas> -->
  <div class="canvas-layout">


    <div class="controls">
      @if (!isDrawingShape) {
      <button (click)="startAddGeofence()">Add Geofence</button>
      }
      <button (click)="zoomIn()">Zoom In (+)</button>
      <button (click)="zoomOut()">Zoom In (-)</button>
      <button (click)="resetView()">Reset</button>
      <button (click)="clearGeofences()">Clear all Geofences</button>
      <button (click)="toggleDeleteMode()">
        {{ deleteMode ? "Cancel Delete" : "Select to delete Fence" }}
      </button>
      <button (click)="togglePath()">
        {{ showPath ? "Hide path" : "Show path" }}
      </button>
      <button (click)="toggleMarkers()">
        {{ toggleMarker ? "Hide Markers" : "Show Markers" }}
      </button>
      <button (click)="togglePadestrians()">
        {{ togglePadestrian ? "Hide Padestrians" : "Show Padestrian" }}
      </button>
      <button (click)="toggleAuras()">
        {{ toggleAura ? "Hide Aura" : "Show Aura" }}
      </button>
      <div *ngIf="shapeMode === 'free' && isDrawingShape">
        <button (click)="undoLastFreePoint()" [disabled]="currentPolygon.length <= 1">
          Undo
        </button>
        <button (click)="finalizeShape()">Finalize Free Shape</button>
      </div>
      <!-- <div *ngIf="hoveredShape"> -->
      <button (click)="copyGeofence()">Copy geofence </button>

      <button (click)="toggleGrid()">
        {{ gridEnabled ? "Hide Grid" : "Show Grid" }}
      </button>

      <button routerLink="/robot-intensity">Robot-Vibration</button>
      <button routerLink="/robot-speed">Robot-Speed</button>
    </div>

    <div class="canvas-wrapper">
      <img #mapImage id="map-image" [src]="mapImageSrc" hidden />
      <canvas #mapCanvas id="map-canvas" (click)="onCanvasClick($event)"></canvas>
    </div>
  </div>
</div>

<div class="fence-log">
  <!-- <h3>Fence Entry Log</h3> -->
  <ul>
    <li *ngFor="let log of fenceLog">
      {{ log.robot }} → FenceName - '{{ log.fenceName }}' at
      {{ log.time | date : "shortTime" }}
    </li>
  </ul>
</div>

<div class="shape-options" *ngIf="shapeMode !== 'free'">
  <ng-container [ngSwitch]="shapeMode">
    <div *ngSwitchCase="'circle'">
      <label>Radius: <input type="number" [(ngModel)]="circleRadius" /></label>
    </div>
    <div *ngSwitchCase="'square'">
      <label>Side length: <input type="number" [(ngModel)]="squareSize" /></label>
    </div>
    <!-- <div *ngSwitchCase="'triangle'">
        <label>Base: <input type="number" [(ngModel)]="triangleBase" /></label
        ><br />
        <label
          >Height: <input type="number" [(ngModel)]="triangleHeight"
        /></label>
      </div> -->
  </ng-container>
</div>

<div class="robot-info">
  <h5><b>Robot Coords</b></h5>

  <h6 *ngIf="coord"> X -> {{coord.x | number : '1.2-2'}} <br /> Y -> {{coord.y | number: '1.2-2'}} </h6>
  <div *ngIf="robots.length > 0; else noRobot">
    <div *ngFor="let r of robots">
      <strong>{{ r.name || "Robot " }}</strong><br />
      X: {{ r.x | number : "1.2-2" }} <br />
      Y: {{ r.y | number : "1.2-2" }} <br />
      Z: {{ r.z }} <br />
      speed: {{r.speed | number : '1.2-2'}}m/s

      <hr />
    </div>
  </div>
  <ng-template #noRobot>
    <p>No robots onlines.</p>
  </ng-template>
  <div class="meta-data" *ngIf="metaData.DistanceTravelled !== undefined">
    <!-- <h3>Meta </h3> -->
    <p>
      Distance Travelled:
      {{ metaData.DistanceTravelled | number : "1.2-2" }} m
    </p>
  </div>
  <div class="localisation-status" *ngIf="localisationStatus">
    <p>
      Localisation Status: <strong>{{ localisationStatus }}</strong>
    </p>
  </div>
  <div class="localisation-status" *ngIf="localisationStatus">
    <p>
      <!-- Localisation Status: <strong>{{  }}</strong> -->
    </p>
  </div>
  <h5><b>Pedestrians</b></h5>
  <p>
    Detected Pedestrians: <strong>{{ pedestrians.length }}</strong>
  </p>
  <div *ngIf="closestPedestrianDistance !== null">
    Closest pedestrian:
    {{ closestPedestrianDistance | number: '1.2-2' }} m
  </div>
</div>

<ng-template #geofenceToolModal let-modal>
  <form [formGroup]="mapForm" #mapFormDirective="ngForm" (ngSubmit)="onToolSubmit(modal)">
    <div class="modal-header">
      <h5 class="modal-title">
        {{ isEditing ? "Edit ffence" : "Create Fence" }}
      </h5>
      <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
    </div>

    <div class="modal-body">
      <div class="mb-3">
        <label>Fence Name</label>
        <input type="text" class="form-control" formControlName="fenceName" />
        @if (mapFormDirective.submitted) { @if
        (hasError('fenceName','required')) {
        <div class="text-danger">Fence Name is required</div>
        }@else if (hasError('fenceName','duplicateName')) {
        <div class="text-danger">Please enter a unique name</div>
        } }
      </div>

      <!-- Select Shape -->
      @if (!isEditing) {
      <div class="mb-3">
        <label>Select Shape</label>
        <select class="form-select" formControlName="shapeMode">
          <!-- <option value="circle">Circle</option> -->
          <option value="square">Square</option>
          <!-- <option value="triangle">Triangle</option> -->
          <option value="free">Free</option>
        </select>
      </div>
      }

      <div class="mb-3" *ngIf="mapForm.value.shapeMode === 'square'">
        <label>Side Length</label>
        <input type="number" class="form-control" formControlName="squareSize" />
        @if (mapFormDirective.submitted) { @if
        (hasError('squareSize','required')) {
        <div class="text-danger">Size is required</div>
        } @else if
        (hasError('squareSize','min')) {
        <div class="text-danger">Size must not be less than 100</div>
        }}
      </div>

      <!-- Select Color -->
      <div class="mb-3">
        <label>Select Color</label>
        <div class="color-palette">
          <button type="button" *ngFor="let c of colors" class="color-btn" [style.background]="c"
            [class.selected]="mapForm.value.color === c" (click)="mapForm.patchValue({ color: c })">
            <span *ngIf="mapForm.value.color === c" class="checkmark">✓</span>
          </button>
        </div>
      </div>
      <div class="mb-3">
        <label>Min Speed (m/s)</label>
        <input type="number" class="form-control" formControlName="minSpeed"
          placeholder="Enter minimum allowed speed" />
        @if (mapFormDirective.submitted) {
        @if(hasError('minSpeed' ,'required')){
        <div class="text-danger">Min speed is required </div>
        } @else if
        (hasError('minSpeed','max')) {
        <div class="text-danger">Min speed must not be greater than 10</div>
        }@else if
        (hasError('minSpeed','min')) {
        <div class="text-danger">Min speed must be greater than 0</div>
        }}
      </div>
      <div class="mb-3">
        <label>Max Speed (m/s)</label>
        <input type="number" class="form-control" formControlName="maxSpeed"
          placeholder="Enter maximum allowed speed" />
        @if (mapFormDirective.submitted) {
        @if(hasError('maxSpeed' ,'required')){
        <div class="text-danger">Max speed is required </div>
        }
        @else if
        (hasError('maxSpeed','max')) {
        <div class="text-danger">Max speed must not be greater than 10</div>
        }@else if
        (hasError('maxSpeed','min')) {
        <div class="text-danger">Max speed must be greater than 0</div>
        }@else if (mapForm.errors?.['maxLessThanMin']) {
        <div class="text-danger"> Max speed must be greater than or equal to Min speed.</div>
        }}
      </div>
      <div class="mb-3">
        <label>Time Duration (mins)</label>
        <input type="number" class="form-control" formControlName="timeLimitMinutes"
          placeholder="Enter maximum allowed speed" />
        @if (mapFormDirective.submitted) {
        @if(hasError('timeLimitMinutes' ,'required')){
        <div class="text-danger">Duration is required </div>
        }
        }
      </div>
      <!-- Draggable / Resizable -->
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="drag" formControlName="isDrag" />
        <label class="form-check-label" for="drag">Draggable</label>
      </div>
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="resize" formControlName="isResize" />
        <label class="form-check-label" for="resize">Resizable</label>
      </div>
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="restrict" formControlName="isRestricted" />
        <label class="form-check-label" for="restrict">Restricted</label>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="modal.dismiss()">
        Cancel
      </button>
      <button class="btn btn-primary" type="submit">
        {{ isEditing ? "Save Changes" : "Create" }}
      </button>
    </div>
  </form>
</ng-template>
<app-toast-notification></app-toast-notification>